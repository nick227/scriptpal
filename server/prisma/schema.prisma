generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

enum ScriptStatus {
  draft
  in_progress
  complete
}

enum Visibility {
  private
  public
}

enum ChatRole {
  user
  assistant
}

enum CommandAuthor {
  user
  ai
  system
}

enum ElementSource {
  user
  ai
  system
}

enum BrainstormCategory {
  general
  story
  character
  location
}

enum MediaType {
  image
  video
}

enum MediaStatus {
  processing
  ready
  failed
}

enum MediaVisibility {
  private
  shared
  public
}

enum MediaOwnerType {
  script
  scene
  character
  location
  theme
}

enum MediaRole {
  cover
  inline
  gallery
  reference
}

enum MediaSource {
  upload
  ai
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  passwordSalt String
  createdAt    DateTime @default(now())

  scripts          Script[]
  sessions         Session[]
  personas         Persona[]
  slugs            ScriptSlug[]      @relation("UserSlugs")
  chatMessages     ChatMessage[]
  scriptComments   ScriptComment[]
  brainstormBoards BrainstormBoard[]
  mediaAssets      MediaAsset[]

  @@map("users")
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([expiresAt])
  @@map("sessions")
}

model Script {
  id          Int          @id @default(autoincrement())
  userId      Int
  title       String
  author      String?
  description String?      @db.LongText
  tags        Json         @default("[]")
  slug        String?      @db.VarChar(80)
  publicId    String?      @db.VarChar(32) @unique
  status      ScriptStatus @default(draft)
  visibility  Visibility   @default(private)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user           User            @relation(fields: [userId], references: [id])
  versions       ScriptVersion[]
  commands       ScriptCommand[]
  elements       ScriptElement[]
  pages          ScriptPage[]
  personas       Persona[]
  scenes         Scene[]
  outlines       Outline[]
  characters     Character[]
  locations      Location[]
  themes         Theme[]
  slugs          ScriptSlug[]    @relation("ScriptSlugs")
  chatMessages   ChatMessage[]
  scriptComments ScriptComment[]

  @@unique([userId, slug])
  @@index([slug])
  @@map("scripts")
}

model ScriptSlug {
  id          Int      @id @default(autoincrement())
  userId      Int
  scriptId    Int
  slug        String   @db.VarChar(80)
  isCanonical Boolean  @default(true)
  createdAt   DateTime @default(now())

  user   User   @relation("UserSlugs", fields: [userId], references: [id])
  script Script @relation("ScriptSlugs", fields: [scriptId], references: [id])

  @@unique([userId, slug])
  @@index([slug])
  @@index([scriptId, isCanonical])
  @@map("script_slugs")
}

model ScriptVersion {
  id            Int      @id @default(autoincrement())
  scriptId      Int
  versionNumber Int
  content       String   @db.LongText
  createdAt     DateTime @default(now())

  script Script @relation(fields: [scriptId], references: [id])

  @@unique([scriptId, versionNumber])
  @@index([scriptId, versionNumber])
  @@map("script_versions")
}

model ScriptCommand {
  id        Int           @id @default(autoincrement())
  scriptId  Int
  type      String
  payload   Json
  author    CommandAuthor
  createdAt DateTime      @default(now())

  script Script @relation(fields: [scriptId], references: [id])

  @@map("script_commands")
}

model ScriptPage {
  id        Int      @id @default(autoincrement())
  scriptId  Int
  order     Int
  content   String   @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@map("script_pages")
}

model ChatMessage {
  id               Int      @id @default(autoincrement())
  userId           Int
  scriptId         Int?
  role             ChatRole
  content          String   @db.LongText
  intent           String?
  metadata         Json?
  promptTokens     Int?     @map("prompt_tokens")
  completionTokens Int?     @map("completion_tokens")
  totalTokens      Int?     @map("total_tokens")
  costUsd          Decimal? @map("cost_usd") @db.Decimal(10, 6)
  createdAt        DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id])
  script Script? @relation(fields: [scriptId], references: [id])

  @@index([userId])
  @@index([scriptId])
  @@index([createdAt])
  @@index([userId, scriptId])
  @@map("chat_messages")
}

model Persona {
  id          Int      @id @default(autoincrement())
  description String   @db.LongText
  scriptId    Int
  userId      Int
  createdAt   DateTime @default(now())

  script Script @relation(fields: [scriptId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@map("personas")
}

model ScriptElement {
  id        Int           @id @default(autoincrement())
  scriptId  Int
  type      String
  payload   Json
  source    ElementSource
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@map("script_elements")
}

model Scene {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  title       String
  description String?  @db.LongText
  notes       String?  @db.LongText
  tags        Json
  sortIndex   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@index([scriptId])
  @@index([sortIndex])
  @@map("scenes")
}

model Character {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  title       String
  description String?  @db.LongText
  notes       String?  @db.LongText
  tags        Json
  sortIndex   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@index([scriptId])
  @@index([sortIndex])
  @@map("characters")
}

model Location {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  title       String
  description String?  @db.LongText
  notes       String?  @db.LongText
  tags        Json
  sortIndex   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@index([scriptId])
  @@index([sortIndex])
  @@map("locations")
}

model Outline {
  id        Int      @id @default(autoincrement())
  scriptId  Int
  title     String
  items     Json     @default("[]")
  sortIndex Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@index([scriptId])
  @@index([sortIndex])
  @@map("outlines")
}

model Theme {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  title       String
  description String?  @db.LongText
  notes       String?  @db.LongText
  tags        Json
  sortIndex   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@index([scriptId])
  @@index([sortIndex])
  @@map("themes")
}

model ScriptComment {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  userId      Int
  authorLabel String   @db.VarChar(255)
  content     String   @db.LongText
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([scriptId])
  @@index([scriptId, isDeleted])
  @@map("script_comments")
}

model BrainstormBoard {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String   @default("Untitled Board")
  seed      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User             @relation(fields: [userId], references: [id])
  notes BrainstormNote[]

  @@index([userId])
  @@map("brainstorm_boards")
}

model BrainstormNote {
  id        Int                @id @default(autoincrement())
  boardId   Int
  category  BrainstormCategory
  content   String
  createdAt DateTime           @default(now())

  board BrainstormBoard @relation(fields: [boardId], references: [id])

  @@index([boardId])
  @@map("brainstorm_notes")
}

model MediaAsset {
  id              Int             @id @default(autoincrement())
  userId          Int
  type            MediaType
  status          MediaStatus     @default(processing)
  visibility      MediaVisibility @default(private)
  source          MediaSource
  title           String?
  description     String?         @db.LongText
  tags            Json?
  mimeType        String
  sizeBytes       Int?
  width           Int?
  height          Int?
  durationMs      Int?
  storageProvider String
  storageKey      String
  checksum        String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  deletedAt       DateTime?

  user        User              @relation(fields: [userId], references: [id])
  variants    MediaVariant[]
  attachments MediaAttachment[]

  @@index([userId, createdAt])
  @@index([type])
  @@map("media_assets")
}

model MediaVariant {
  id         Int      @id @default(autoincrement())
  assetId    Int
  kind       String
  format     String
  width      Int?
  height     Int?
  sizeBytes  Int?
  provider   String
  storageKey String
  createdAt  DateTime @default(now())

  asset MediaAsset @relation(fields: [assetId], references: [id])

  @@index([assetId])
  @@map("media_variants")
}

model MediaAttachment {
  id        Int            @id @default(autoincrement())
  assetId   Int
  userId    Int
  ownerType MediaOwnerType
  ownerId   Int
  role      MediaRole
  sortOrder Int            @default(0)
  meta      Json?
  createdAt DateTime       @default(now())

  asset MediaAsset @relation(fields: [assetId], references: [id])

  @@unique([ownerType, ownerId, role, assetId])
  @@index([ownerType, ownerId])
  @@index([assetId])
  @@index([userId])
  @@map("media_attachments")
}

model MediaGenerationJob {
  id             Int       @id @default(autoincrement())
  userId         Int
  type           MediaType
  status         String    @default("queued")
  prompt         String    @db.LongText
  negativePrompt String?   @db.LongText
  params         Json?
  provider       String
  model          String
  error          String?   @db.LongText
  resultAssetId  Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@map("media_generation_jobs")
}
