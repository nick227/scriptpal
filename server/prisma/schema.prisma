generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

enum ScriptStatus {
  draft
  in_progress
  complete
}

enum Visibility {
  private
  public
}

enum ChatRole {
  user
  assistant
}

enum CommandAuthor {
  user
  ai
  system
}

enum ElementSource {
  user
  ai
  system
}

enum BrainstormCategory {
  general
  story
  character
  location
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  passwordSalt String
  createdAt    DateTime @default(now())

  scripts        Script[]
  sessions       Session[]
  personas       Persona[]
  chatMessages   ChatMessage[]
  scriptComments ScriptComment[]
  brainstormBoards BrainstormBoard[]

  @@map("users")
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model Script {
  id          Int          @id @default(autoincrement())
  userId      Int
  title       String
  author      String?
  description String?      @db.LongText
  slug        String?      @db.VarChar(80)
  status      ScriptStatus @default(draft)
  visibility  Visibility   @default(private)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user           User            @relation(fields: [userId], references: [id])
  versions       ScriptVersion[]
  commands       ScriptCommand[]
  elements       ScriptElement[]
  pages          ScriptPage[]
  personas       Persona[]
  scenes         Scene[]
  characters     Character[]
  locations      Location[]
  themes         Theme[]
  chatMessages   ChatMessage[]
  scriptComments ScriptComment[]

  @@unique([userId, slug])
  @@index([slug])
  @@map("scripts")
}

model ScriptVersion {
  id            Int      @id @default(autoincrement())
  scriptId      Int
  versionNumber Int
  content       String   @db.LongText
  createdAt     DateTime @default(now())

  script Script @relation(fields: [scriptId], references: [id])

  @@unique([scriptId, versionNumber])
  @@map("script_versions")
}

model ScriptCommand {
  id        Int           @id @default(autoincrement())
  scriptId  Int
  type      String
  payload   Json
  author    CommandAuthor
  createdAt DateTime      @default(now())

  script Script @relation(fields: [scriptId], references: [id])

  @@map("script_commands")
}

model ScriptPage {
  id        Int      @id @default(autoincrement())
  scriptId  Int
  order     Int
  content   String   @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@map("script_pages")
}

model ChatMessage {
  id               Int      @id @default(autoincrement())
  userId           Int
  scriptId         Int?
  role             ChatRole
  content          String   @db.LongText
  intent           String?
  metadata         Json?
  promptTokens     Int?     @map("prompt_tokens")
  completionTokens Int?     @map("completion_tokens")
  totalTokens      Int?     @map("total_tokens")
  costUsd          Decimal? @map("cost_usd") @db.Decimal(10, 6)
  createdAt        DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id])
  script Script? @relation(fields: [scriptId], references: [id])

  @@map("chat_messages")
}

model Persona {
  id          Int      @id @default(autoincrement())
  description String   @db.LongText
  scriptId    Int
  userId      Int
  createdAt   DateTime @default(now())

  script Script @relation(fields: [scriptId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@map("personas")
}

model ScriptElement {
  id        Int           @id @default(autoincrement())
  scriptId  Int
  type      String
  payload   Json
  source    ElementSource
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@map("script_elements")
}

model Scene {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  title       String
  description String?  @db.LongText
  notes       String?  @db.LongText
  tags        Json
  sortIndex   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@index([scriptId])
  @@index([sortIndex])
  @@map("scenes")
}

model Character {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  title       String
  description String?  @db.LongText
  notes       String?  @db.LongText
  tags        Json
  sortIndex   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@index([scriptId])
  @@index([sortIndex])
  @@map("characters")
}

model Location {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  title       String
  description String?  @db.LongText
  notes       String?  @db.LongText
  tags        Json
  sortIndex   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@index([scriptId])
  @@index([sortIndex])
  @@map("locations")
}

model Theme {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  title       String
  description String?  @db.LongText
  notes       String?  @db.LongText
  tags        Json
  sortIndex   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])

  @@index([scriptId])
  @@index([sortIndex])
  @@map("themes")
}

model ScriptComment {
  id          Int      @id @default(autoincrement())
  scriptId    Int
  userId      Int
  authorLabel String   @db.VarChar(255)
  content     String   @db.LongText
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([scriptId])
  @@index([scriptId, isDeleted])
  @@map("script_comments")
}

model BrainstormBoard {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String   @default("Untitled Board")
  seed      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User             @relation(fields: [userId], references: [id])
  notes BrainstormNote[]

  @@index([userId])
  @@map("brainstorm_boards")
}

model BrainstormNote {
  id        Int                @id @default(autoincrement())
  boardId   Int
  category  BrainstormCategory
  content   String
  createdAt DateTime           @default(now())

  board BrainstormBoard @relation(fields: [boardId], references: [id])

  @@index([boardId])
  @@map("brainstorm_notes")
}
