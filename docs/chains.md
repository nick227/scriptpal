# Chains Overview

## Architecture snapshot
- `ChainFactory` is responsible for importing every flow and registering the active intents: `WriteScript` at `server/controllers/langchain/chains/ChainFactory.js:20`, `EditScript` at `server/controllers/langchain/chains/ChainFactory.js:23`, `SaveElement` at `server/controllers/langchain/chains/ChainFactory.js:26`, `ScriptQuestions` at `server/controllers/langchain/chains/ChainFactory.js:29`, `ScriptAnalyzer` at `server/controllers/langchain/chains/ChainFactory.js:30`, `Inspiration` at `server/controllers/langchain/chains/ChainFactory.js:33`, and `Default` at `server/controllers/langchain/chains/ChainFactory.js:36`.
- The registry remains a thin `Map` that only exposes `getChain`, `registerChain`, `getRegisteredIntents`, `isInitialized`, and `getStatus` (`server/controllers/langchain/chains/registry.js:15`, `server/controllers/langchain/chains/registry.js:21`, `server/controllers/langchain/chains/registry.js:30`, `server/controllers/langchain/chains/registry.js:38`, `server/controllers/langchain/chains/registry.js:46`, `server/controllers/langchain/chains/registry.js:68`), so every lookup funnels through it.
- `IntentRouter` pulls from that registry and instantiates the returned class before calling `run` (`server/controllers/langchain/router/index.js:61`, `server/controllers/langchain/router/index.js:66`, `server/controllers/langchain/router/index.js:78`).

## Active chains
- **WriteScriptChain** builds prompts with `EditScriptLoader`/`WriteScriptMessages`, turns the response into edit commands, and delegates to `BaseChain.execute`; it is registered under `INTENT_TYPES.WRITE_SCRIPT` (`server/controllers/langchain/chains/edit/WriteScript.js:8`, `server/controllers/langchain/chains/edit/WriteScript.js:15`, `server/controllers/langchain/chains/edit/WriteScript.js:25`).
- **EditScriptChain** loads the target script, asks the model for edit commands via `EditScriptMessages`, validates the commands, and applies them with `ScriptVersionService`; it is the registered handler for `INTENT_TYPES.EDIT_SCRIPT` (`server/controllers/langchain/chains/edit/EditScript.js:7`, `server/controllers/langchain/chains/edit/EditScript.js:14`, `server/controllers/langchain/chains/edit/EditScript.js:25`).
- **SaveElementChain** parses a structured save command and delegates to `SaveElementHandler` when `INTENT_TYPES.SAVE_ELEMENT` triggers it (`server/controllers/langchain/chains/save/SaveElementChain.js:5`, `server/controllers/langchain/chains/save/SaveElementChain.js:15`).
- **ScriptQuestionsChain** enforces `<h2>/<p>` formatting, loads saved elements, and calls `BaseChain.execute` for `INTENT_TYPES.SCRIPT_QUESTIONS` (`server/controllers/langchain/chains/creative/scriptQuestions.js:27`, `server/controllers/langchain/chains/creative/scriptQuestions.js:67`).
- **ScriptAnalyzerChain** normalizes the script, keeps higher token limits, saves the analysis, and returns a narrative response while handling the `INTENT_TYPES.ANALYZE_SCRIPT` registration (`server/controllers/langchain/chains/analysis/scriptAnalyzer.js:7`, `server/controllers/langchain/chains/analysis/scriptAnalyzer.js:96`, `server/controllers/langchain/chains/analysis/scriptAnalyzer.js:157`).
- **InspirationChain** pulls the script content together with saved elements, falls back to a hardcoded prompt if templates are missing, and runs `BaseChain.execute` with a higher temperature for `INTENT_TYPES.GET_INSPIRATION` (`server/controllers/langchain/chains/creative/inspirationGen.js:8`, `server/controllers/langchain/chains/creative/inspirationGen.js:95`).
- **DefaultChain** covers `INTENT_TYPES.EVERYTHING_ELSE` by wrapping a general assistant instruction and always returning the standard question set (`server/controllers/langchain/chains/base/DefaultChain.js:5`, `server/controllers/langchain/chains/base/DefaultChain.js:19`, `server/controllers/langchain/chains/base/DefaultChain.js:66`).

## Legacy or orphaned pieces
- `SceneListChain` and `BeatListChain` are still imported in `ChainFactory` (`server/controllers/langchain/chains/ChainFactory.js:6`, `server/controllers/langchain/chains/ChainFactory.js:7`) but never registered, so the logic in `server/controllers/langchain/chains/creative/sceneLister.js:6` and `server/controllers/langchain/chains/creative/beatLister.js:6` is unreachable.
- `NarrativeAnalyzerChain` lives in `server/controllers/langchain/chains/creative/NarrativeAnalyzer.js:1` but is not wired into the registry, so nothing can trigger that analysis flow.
- `generateButtons` (`server/controllers/langchain/chains/generateButtons.js:1`) and `generateResponse` (`server/controllers/langchain/chains/generateResponse.js:1`) still exist but none of the registered chains import them anymore, indicating they belong to an older architecture.
- `RawScriptEditHelper` is only a stub of error constants and an empty class (`server/controllers/langchain/chains/helpers/RawScriptEditHelper.js:16`), with no live callers.

## Observations & next steps
- `IntentRouter.handleMultiIntent` calls `chainRegistry.execute` (`server/controllers/langchain/router/index.js:90`, `server/controllers/langchain/router/index.js:102`), yet the registry export never defines such a helper (`server/controllers/langchain/chains/registry.js:15`, `server/controllers/langchain/chains/registry.js:21`, `server/controllers/langchain/chains/registry.js:30`, `server/controllers/langchain/chains/registry.js:38`), so multi-intent routing is guaranteed to throw unless the helper is added or the code is adjusted.
- The editing and saving chains still call `this.llm.invoke` (`server/controllers/langchain/chains/edit/EditScript.js:25`, `server/controllers/langchain/chains/edit/WriteScript.js:25`, `server/controllers/langchain/chains/save/SaveElementChain.js:16`), but `BaseChain.execute` now uses the shared `ai.generateCompletion` client (`server/controllers/langchain/chains/base/BaseChain.js:222`) and never assigns `this.llm`. `docs/BACKEND_AI_ANALYSIS.md:53` notes that per-chain `this.llm` builders were removed, so these overrides likely throw `undefined` unless the chains are updated to use `ai` or a new `llm` instance is injected.
- If the scene/beat/narrative modules need to come back, register them alongside the other flows and add the corresponding UI/intent hooks; otherwise remove the files or mark them as archived so they stop cluttering the directory (`server/controllers/langchain/chains/ChainFactory.js:4`, `server/controllers/langchain/chains/ChainFactory.js:6`, `server/controllers/langchain/chains/ChainFactory.js:7`).
- Clean up `generateButtons`/`generateResponse` or relocate them to the legacy code path that once consumed them, because they still pull in `chatModels.js`/`prompts.js` but are not part of the current runtime.
