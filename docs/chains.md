# Chains Overview

## Architecture snapshot
- `ChainFactory` is responsible for importing every flow and registering the active intents: `WriteScript` at `server/controllers/langchain/chains/ChainFactory.js:20`, `EditScript` at `server/controllers/langchain/chains/ChainFactory.js:23`, `SaveElement` at `server/controllers/langchain/chains/ChainFactory.js:26`, `ScriptQuestions` at `server/controllers/langchain/chains/ChainFactory.js:29`, `ScriptAnalyzer` at `server/controllers/langchain/chains/ChainFactory.js:30`, `Inspiration` at `server/controllers/langchain/chains/ChainFactory.js:33`, and `Default` at `server/controllers/langchain/chains/ChainFactory.js:36`.
- The registry remains a thin `Map` that only exposes `getChain`, `registerChain`, `getRegisteredIntents`, `isInitialized`, and `getStatus` (`server/controllers/langchain/chains/registry.js:15`, `server/controllers/langchain/chains/registry.js:21`, `server/controllers/langchain/chains/registry.js:30`, `server/controllers/langchain/chains/registry.js:38`, `server/controllers/langchain/chains/registry.js:46`, `server/controllers/langchain/chains/registry.js:68`), so every lookup funnels through it.
- `IntentRouter` pulls from that registry and instantiates the returned class before calling `run` (`server/controllers/langchain/router/index.js:61`, `server/controllers/langchain/router/index.js:66`, `server/controllers/langchain/router/index.js:78`).

## Active chains
- **WriteScriptChain** builds prompts with `EditScriptLoader`/`WriteScriptMessages`, turns the response into edit commands, and delegates to `BaseChain.execute`; it is registered under `INTENT_TYPES.WRITE_SCRIPT` (`server/controllers/langchain/chains/edit/WriteScript.js:8`, `server/controllers/langchain/chains/edit/WriteScript.js:15`, `server/controllers/langchain/chains/edit/WriteScript.js:25`).
- **EditScriptChain** loads the target script, asks the model for edit commands via `EditScriptMessages`, validates the commands, and applies them with `ScriptVersionService`; it is the registered handler for `INTENT_TYPES.EDIT_SCRIPT` (`server/controllers/langchain/chains/edit/EditScript.js:7`, `server/controllers/langchain/chains/edit/EditScript.js:14`, `server/controllers/langchain/chains/edit/EditScript.js:25`).
- **SaveElementChain** parses a structured save command and delegates to `SaveElementHandler` when `INTENT_TYPES.SAVE_ELEMENT` triggers it (`server/controllers/langchain/chains/save/SaveElementChain.js:5`, `server/controllers/langchain/chains/save/SaveElementChain.js:15`).
- **ScriptQuestionsChain** enforces `<h2>/<p>` formatting, loads saved elements, and calls `BaseChain.execute` for `INTENT_TYPES.SCRIPT_QUESTIONS` (`server/controllers/langchain/chains/creative/scriptQuestions.js:27`, `server/controllers/langchain/chains/creative/scriptQuestions.js:67`).
- **ScriptAnalyzerChain** normalizes the script, keeps higher token limits, saves the analysis, and returns a narrative response while handling the `INTENT_TYPES.ANALYZE_SCRIPT` registration (`server/controllers/langchain/chains/analysis/scriptAnalyzer.js:7`, `server/controllers/langchain/chains/analysis/scriptAnalyzer.js:96`, `server/controllers/langchain/chains/analysis/scriptAnalyzer.js:157`).
- **InspirationChain** pulls the script content together with saved elements, falls back to a hardcoded prompt if templates are missing, and runs `BaseChain.execute` with a higher temperature for `INTENT_TYPES.GET_INSPIRATION` (`server/controllers/langchain/chains/creative/inspirationGen.js:8`, `server/controllers/langchain/chains/creative/inspirationGen.js:95`).
- **DefaultChain** covers `INTENT_TYPES.EVERYTHING_ELSE` by wrapping a general assistant instruction and always returning the standard question set (`server/controllers/langchain/chains/base/DefaultChain.js:5`, `server/controllers/langchain/chains/base/DefaultChain.js:19`, `server/controllers/langchain/chains/base/DefaultChain.js:66`).

## Legacy or archived pieces
- Scene/beat/narrative helpers along with `generateButtons`, `generateResponse`, and the stubbed `RawScriptEditHelper` now live under `server/controllers/langchain/chains/_archived`; they are intentionally removed from the registry so they no longer clutter the hot path.
- If any of these flows need to come back (e.g., a multi-step assistant or helper UI), move the specific file back into its active directory, wire it into `ChainFactory`, and provide a test for the new intent before turning it on.

## Observations & next steps
- Multi-intent routing was removed from `IntentRouter` because there was no working `chainRegistry.execute` helper; the class now only exposes the single-intent path, and broken paths have been pruned so the call stack is straightforward.
- Edit/Save chains now call `ai.generateCompletion` (with their function schema or structured JSON instructions) instead of `this.llm`, so the shared AI client is the single point of contact and there is no risk of `undefined` runtime errors.
- Legacy helpers and unused chains now live under `_archived`; keep the scattered JSON/XML utilities there until someone is ready to rewire them to current intent handling instead of leaving them in the hot path.
